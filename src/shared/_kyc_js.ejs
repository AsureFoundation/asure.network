<script src='https://www.google.com/recaptcha/api.js'></script>

<script>
    function KycManager() {
        var self = this;

        /**
         * Checks if the given string is an address
         *
         * @method isAddress
         * @param {String} address the given HEX adress
         * @return {Boolean}
         */
        var isAddress = function (address) {
            if (!/^(0x)?[0-9a-f]{40}$/i.test(address)) {
                // check if it has the basic requirements of an address
                return false;
            } else if (/^(0x)?[0-9a-f]{40}$/.test(address) || /^(0x)?[0-9A-F]{40}$/.test(address)) {
                // If it's all small caps or all all caps, return true
                return true;
            } else {
                // Otherwise check each case
                return isChecksumAddress(address);
            }
        };

        /**
         * Checks if the given string is a checksummed address
         *
         * @method isChecksumAddress
         * @param {String} address the given HEX adress
         * @return {Boolean}
         */
        var isChecksumAddress = function (address) {
            // Check each case
            address = address.replace('0x', '');
            var addressHash = sha3(address.toLowerCase());
            for (var i = 0; i < 40; i++) {
                // the nth letter should be uppercase if the nth digit of casemap is 1
                if ((parseInt(addressHash[i], 16) > 7 && address[i].toUpperCase() !== address[i]) || (parseInt(addressHash[i], 16) <= 7 && address[i].toLowerCase() !== address[i])) {
                    return false;
                }
            }
            return true;
        };

        self.recaptchaOk = false;

        self.validateWallet = function (evt) {
            if (!isAddress(this.value)) {
                this.setCustomValidity('"' + this.value + '" is not a valid address.');
            } else {
                // input is fine -- reset the error message
                this.setCustomValidity("");
            }
        };

        self.validate = function () {
            if (self.form[0].checkValidity()) {
                self.form.removeClass('was-validated');
                return true;
            }

            self.form.addClass('was-validated');
            return false;
        };

        self.submit = function (evt) {
            evt.preventDefault();

            if (!self.validate()) {
                return;
            }

            var formData = new FormData(this);

            jQuery.support.cors = true;

            $.ajax({
                url: "https://kyc.echtnice.com",
                type: 'POST',
                dataType: "json",
                contentType: false,
                data: formData,
                crossDomain: true,
                success: function (data) {
                    if (data.status === true) {
                        $('#card-registration').hide();
                        $('#card-registration-successful').show();
                    } else {
                        $('.alert.alert-warning').show(); // error
                        $('.alert.alert-warning span.error-list').html("");
                        if (data.errors) {
                            var data_errors = JSON.parse(data.errors);
                            $('.alert.alert-warning p.error-list').html(data_errors.map(x => x + "<br/>"));
                        }
                    }
                    $(".form").trigger("reset");
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    $("input[type='submit']").prop('disabled', false);
                },
                cache: false,
                processData: false
            });
        }

        self.init = function () {
            self.form = $('form#form-kyc');
            self.form.find('[name="_wallet"]').on('input', self.validateWallet);
            self.form.submit(self.submit);
        }
    }

    var kycManager = new KycManager();
    kycManager.init();




    function recaptchaCallback() {
        kycManager.recaptchaOk = true;
        //$("form#form-kyc input,form#form-kyc select").trigger("change");
    }

    //$("form#form-kyc input,form#form-kyc select").change(function () {
    //    var fn = isNotUndefinedAndEmpty($("input[name='_fn']").val());
    //    // fn ? $("input[name='_fn']").addClass("is-valid") : $("input[name='_fn']").removeClass("is-valid");
    //    //fn?$("#fg_fn").removeClass("form-error"):$("#fg_fn").addClass("form-error");
    //
    //    var ln = isNotUndefinedAndEmpty($("input[name='_ln']").val());
    //    // ln ? $("input[name='_ln']").addClass("is-valid") : $("input[name='_ln']").removeClass("is-valid");
    //    var us = isNotUndefinedAndEmpty($("input[name='_us']:checked").val());
    //    var exposed = isNotUndefinedAndEmpty($("input[name='_exposed']:checked").val());
    //    var citizenship = $("select[name='_citizenship']").val() != "0";
    //    var tel = isNotUndefinedAndEmpty($("input[name='_tel']").val());
    //    // tel ? $("input[name='_tel']").addClass("is-valid") : $("input[name='_tel']").removeClass("is-valid");
    //    var address = isNotUndefinedAndEmpty($("input[name='_address']").val());
    //    // address ? $("input[name='_address']").addClass("is-valid") : $("input[name='_address']").removeClass("is-valid");
    //    var city = isNotUndefinedAndEmpty($("input[name='_city']").val());
    //    // city ? $("input[name='_city']").addClass("is-valid") : $("input[name='_city']").removeClass("is-valid");
    //    var postcode = isNotUndefinedAndEmpty($("input[name='_postcode']").val());
    //    // postcode ? $("input[name='_postcode']").addClass("is-valid") : $("input[name='_postcode']").removeClass("is-valid");
    //    var country = $("select[name='_country']").val() != "0";
    //    // country ? $("input[name='_country']").addClass("is-valid") : $("input[name='_country']").removeClass("is-valid");
    //    var wallet = isAddress($("input[name='_wallet']").val());
    //    // wallet ? $("input[name='_wallet']").addClass("is-valid") : $("input[name='_wallet']").removeClass("is-valid");
    //
    //    // wallet ? $(".wallet-error").addClass("hidden") : $(".wallet-error").removeClass("hidden");
    //
    //
    //    var eth = isNumber($("input[name='_eth']").val());
    //    // eth ? $("input[name='_eth']").addClass("is-valid") : $("input[name='_eth']").removeClass("is-valid");
    //
    //    var sourceOfFounds = isNotUndefinedAndEmpty($("input[name='_sourceOfFounds']").val());
    //    // sourceOfFounds ? $("input[name='_sourceOfFounds']").addClass("is-valid") : $("input[name='_sourceOfFounds']").removeClass("is-valid");
    //
    //    var file_id = isNotUndefinedAndEmpty($("input[name='_file_id']").val());
    //    var file_photo = isNotUndefinedAndEmpty($("input[name='_file_photo']").val());
    //
    //    var policy = isNotUndefinedAndEmpty($("input[name='_policy']:checked").val());
    //    var terms = isNotUndefinedAndEmpty($("input[name='_terms']:checked").val());
    //
    //    if (fn && ln &&
    //        us && exposed && citizenship &&
    //        tel && address && city && postcode && country &&
    //        wallet && eth && sourceOfFounds &&
    //        file_id && file_photo && policy && terms &&
    //        recaptchaOk) {
    //        $("input[type='submit']").prop('disabled', false);
    //        $('.alert.alert-warning').hide();
    //    } else {
    //        $("input[type='submit']").prop('disabled', true);
    //        $('.alert.alert-warning').show();
    //    }
    //    //$("input[type='submit']").prop('disabled', false);
    //});
    //
    //$("form#form-kyc").submit(function (e) {
    //    $("input[type='submit']").prop('disabled', true);
    //    e.preventDefault();
    //    var formData = new FormData(this);
    //
    //    jQuery.support.cors = true;
    //
    //    $.ajax({
    //        url: "https://kyc.echtnice.com",
    //        type: 'POST',
    //        dataType: "json",
    //        contentType: false,
    //        data: formData,
    //        crossDomain: true,
    //        success: function (data) {
    //            if (data.status === true) {
    //                $('#card-registration').hide();
    //                $('#card-registration-successful').show();
    //            } else {
    //                $('.alert.alert-warning').show(); // error
    //                $('.alert.alert-warning span.error-list').html("");
    //                if (data.errors) {
    //                    var data_errors = JSON.parse(data.errors);
    //                    $('.alert.alert-warning p.error-list').html(data_errors.map(x => x + "<br/>"));
    //                }
    //            }
    //            $("input[type='submit']").prop('disabled', false);
    //            $(".form").trigger("reset");
    //        },
    //        error: function (xhr, ajaxOptions, thrownError) {
    //            $("input[type='submit']").prop('disabled', false);
    //        },
    //        cache: false,
    //        processData: false
    //    });
    //});

</script>